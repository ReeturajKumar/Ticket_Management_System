{
  "API_DOCUMENTATION": "Student Ticketing System - Critical Fixes & Enhanced Features",
  "BASE_URL": "http://localhost:5000/api/v1",
  "VERSION": "2.0 - With Pagination, Transactions, Close Ticket, File Download",
  "CRITICAL_FIXES_IMPLEMENTED": {
    "Fix 1": "Pagination added to Student Tickets - Prevents performance issues",
    "Fix 2": "MongoDB Transactions for Bulk Operations - Ensures atomic operations",
    "Fix 3": "Close Ticket Endpoint - Complete ticket lifecycle",
    "Fix 4": "File Download Endpoint - Students can download attachments"
  },
  "STUDENT_TICKET_APIS_ENHANCED": {
    "List Tickets API (WITH PAGINATION)": "http://localhost:5000/api/v1/tickets",
    "List Tickets Description": "✨ NOW WITH PAGINATION - Get user's tickets with page/limit support",
    "List Tickets Request": "GET request with Authorization header and query params",
    "List Tickets Query Params": {
      "page": "1 (default: 1)",
      "limit": "20 (default: 20)",
      "status": "OPEN | ASSIGNED | IN_PROGRESS | RESOLVED | CLOSED (optional)",
      "priority": "LOW | MEDIUM | HIGH | CRITICAL (optional)",
      "department": "PLACEMENT | OPERATIONS | TRAINING | FINANCE (optional)"
    },
    "List Tickets Example URL": "http://localhost:5000/api/v1/tickets?page=1&limit=20&status=OPEN",
    "List Tickets Response": {
      "success": true,
      "data": {
        "tickets": [
          {
            "id": "65f1a2b3c4d5e6f7g8h9i0j2",
            "subject": "Need help with resume",
            "status": "OPEN",
            "priority": "MEDIUM",
            "department": "PLACEMENT",
            "assignedTo": "Unassigned",
            "createdAt": "2026-01-09T10:00:00.000Z",
            "updatedAt": "2026-01-09T10:00:00.000Z"
          }
        ],
        "pagination": {
          "total": 100,
          "page": 1,
          "limit": 20,
          "pages": 5
        }
      }
    },
    "List Tickets Note": "✨ NEW: Pagination prevents loading all tickets at once. Use page/limit for better performance."
  },
  "FILE_ATTACHMENT_APIS": {
    "Upload Attachment API": "http://localhost:5000/api/v1/tickets/:id/attachments",
    "Upload Description": "Upload file attachment to ticket (images, PDF, DOC, etc.)",
    "Upload Request": "POST request with multipart/form-data",
    "Upload Headers": {
      "Authorization": "Bearer <access_token>",
      "Content-Type": "multipart/form-data"
    },
    "Upload Body": {
      "file": "<file object>"
    },
    "Upload Restrictions": {
      "Max Size": "5MB",
      "Allowed Types": "JPG, PNG, GIF, WEBP, PDF, DOC, DOCX, TXT",
      "Permission": "Only ticket owner can upload"
    },
    "Upload Response": {
      "success": true,
      "message": "File uploaded successfully",
      "data": {
        "attachment": {
          "filename": "screenshot-1234567890.png",
          "originalName": "screenshot.png",
          "size": 245678,
          "mimeType": "image/png"
        }
      }
    },
    "Upload Note": "File is stored in /uploads directory. Attachment ID is auto-generated.",
    "Download Attachment API": "http://localhost:5000/api/v1/tickets/:id/attachments/:attachmentId",
    "Download Description": "✨ NEW - Download uploaded attachment from ticket",
    "Download Request": "GET request with Authorization header",
    "Download Headers": {
      "Authorization": "Bearer <access_token>"
    },
    "Download Response": "File stream with correct Content-Type and filename",
    "Download Response Headers": {
      "Content-Type": "image/png (or file's mime type)",
      "Content-Disposition": "attachment; filename=\"screenshot.png\"",
      "Content-Length": "245678"
    },
    "Download Restrictions": {
      "Permission": "Only ticket owner can download",
      "Validation": "File must exist on server"
    },
    "Download Note": "✨ CRITICAL FIX: Students can now download their uploaded files!"
  },
  "TICKET_RATING_API": {
    "Rate Ticket API": "http://localhost:5000/api/v1/tickets/:id/rate",
    "Rate Description": "Rate a resolved or closed ticket with stars and optional comment",
    "Rate Request": "POST request with Authorization header",
    "Rate Headers": {
      "Authorization": "Bearer <access_token>",
      "Content-Type": "application/json"
    },
    "Rate Body": {
      "stars": 5,
      "comment": "Great support! Issue resolved quickly."
    },
    "Rate Validation": {
      "Stars": "Required, must be 1-5",
      "Comment": "Optional, max 500 characters",
      "Ticket Status": "Must be RESOLVED or CLOSED",
      "Permission": "Only ticket owner",
      "Duplicate": "Cannot rate same ticket twice"
    },
    "Rate Response": {
      "success": true,
      "message": "Thank you for your feedback!",
      "data": {
        "rating": {
          "stars": 5,
          "comment": "Great support! Issue resolved quickly."
        }
      }
    },
    "Rate Error (Not Resolved)": {
      "success": false,
      "message": "You can only rate resolved or closed tickets"
    },
    "Rate Error (Already Rated)": {
      "success": false,
      "message": "You have already rated this ticket"
    }
  },
  "DEPARTMENT_HEAD_TICKET_MANAGEMENT": {
    "Close Ticket API": "http://localhost:5000/api/v1/department/tickets/:id/close",
    "Close Description": "✨ NEW - Close a resolved ticket (final step in ticket lifecycle)",
    "Close Request": "PATCH request with Authorization header",
    "Close Headers": {
      "Authorization": "Bearer <head_token>",
      "Content-Type": "application/json"
    },
    "Close Body": {},
    "Close Validation": {
      "Status": "Ticket must be RESOLVED",
      "Permission": "Department head only",
      "Department": "Ticket must belong to head's department"
    },
    "Close Response": {
      "success": true,
      "message": "Ticket closed successfully",
      "data": {
        "id": "65f1a2b3c4d5e6f7g8h9i0j2",
        "status": "CLOSED"
      }
    },
    "Close Error (Not Resolved)": {
      "success": false,
      "message": "Only RESOLVED tickets can be closed"
    },
    "Close Note": "✨ CRITICAL FIX: Complete ticket lifecycle now possible. Workflow: OPEN → ASSIGNED → IN_PROGRESS → RESOLVED → CLOSED",
    "Close Workflow": {
      "Step 1": "Student creates ticket (OPEN)",
      "Step 2": "Head assigns to staff (ASSIGNED)",
      "Step 3": "Staff works on it (IN_PROGRESS)",
      "Step 4": "Staff resolves (RESOLVED)",
      "Step 5": "Student rates ticket",
      "Step 6": "Head closes ticket (CLOSED) ✨ NEW"
    }
  },
  "BULK_OPERATIONS_WITH_TRANSACTIONS": {
    "Bulk Assign Tickets API": "http://localhost:5000/api/v1/department/tickets/bulk-assign",
    "Bulk Assign Description": "✨ NOW TRANSACTIONAL - Assign multiple tickets to team member atomically",
    "Bulk Assign Request": "POST request with Authorization header",
    "Bulk Assign Headers": {
      "Authorization": "Bearer <head_token>",
      "Content-Type": "application/json"
    },
    "Bulk Assign Body": {
      "ticketIds": [
        "65f1a2b3c4d5e6f7g8h9i0j1",
        "65f1a2b3c4d5e6f7g8h9i0j2",
        "65f1a2b3c4d5e6f7g8h9i0j3"
      ],
      "assignedTo": "65f1a2b3c4d5e6f7g8h9i0j9"
    },
    "Bulk Assign Validation": {
      "Permission": "Department head only",
      "Tickets": "All must belong to head's department",
      "Assignee": "Must be team member in same department",
      "Transaction": "All tickets assigned or none (atomic)"
    },
    "Bulk Assign Response": {
      "success": true,
      "message": "Successfully assigned 3 tickets",
      "data": {
        "assignedCount": 3,
        "assignedTo": {
          "id": "65f1a2b3c4d5e6f7g8h9i0j9",
          "name": "Jane Smith"
        }
      }
    },
    "Bulk Assign Note": "✨ CRITICAL FIX: Now uses MongoDB transactions. If any ticket fails, ALL changes are rolled back!",
    "Bulk Assign Transaction Behavior": {
      "Success": "All tickets assigned atomically",
      "Failure": "All changes rolled back, no partial updates",
      "Error Handling": "Automatic rollback on any error"
    },
    "Bulk Update Status API": "http://localhost:5000/api/v1/department/tickets/bulk-status",
    "Bulk Update Description": "✨ NOW TRANSACTIONAL - Update status of multiple tickets atomically",
    "Bulk Update Request": "POST request with Authorization header",
    "Bulk Update Headers": {
      "Authorization": "Bearer <head_token>",
      "Content-Type": "application/json"
    },
    "Bulk Update Body": {
      "ticketIds": [
        "65f1a2b3c4d5e6f7g8h9i0j1",
        "65f1a2b3c4d5e6f7g8h9i0j2"
      ],
      "status": "RESOLVED"
    },
    "Bulk Update Validation": {
      "Permission": "Department head only",
      "Tickets": "All must belong to head's department",
      "Status": "Valid status only (OPEN, ASSIGNED, IN_PROGRESS, RESOLVED, etc.)",
      "Restriction": "Cannot update CLOSED tickets",
      "Transaction": "All tickets updated or none (atomic)"
    },
    "Bulk Update Response": {
      "success": true,
      "message": "Successfully updated 2 tickets to RESOLVED",
      "data": {
        "updatedCount": 2,
        "status": "RESOLVED"
      }
    },
    "Bulk Update Note": "✨ CRITICAL FIX: Transactional updates ensure data integrity. Auto-sets resolvedAt when status is RESOLVED.",
    "Bulk Update Transaction Behavior": {
      "Success": "All tickets updated atomically",
      "Failure": "All changes rolled back",
      "Auto-Fields": "resolvedAt set automatically for RESOLVED status"
    }
  },
  "EXPORT_REPORTS_REAL_FILES": {
    "Export Report API": "http://localhost:5000/api/v1/department/reports/export",
    "Export Description": "✨ NOW GENERATES REAL FILES - Export department data as CSV or PDF",
    "Export Request": "GET request with Authorization header and query params",
    "Export Headers": {
      "Authorization": "Bearer <head_token>"
    },
    "Export Query Params": {
      "format": "csv | pdf (required)",
      "type": "tickets | team | summary (required)",
      "startDate": "2026-01-01 (optional)",
      "endDate": "2026-01-31 (optional)"
    },
    "Export Examples": {
      "CSV Tickets": "http://localhost:5000/api/v1/department/reports/export?format=csv&type=tickets",
      "PDF Summary": "http://localhost:5000/api/v1/department/reports/export?format=pdf&type=summary",
      "CSV Team": "http://localhost:5000/api/v1/department/reports/export?format=csv&type=team&startDate=2026-01-01&endDate=2026-01-31"
    },
    "Export CSV Response": {
      "success": true,
      "data": {
        "downloadUrl": "/downloads/placement-tickets-2026-01.csv",
        "fileName": "placement-tickets-2026-01.csv",
        "fileSize": "12.45KB",
        "expiresAt": "2026-01-12T13:42:00.000Z"
      }
    },
    "Export PDF Response": {
      "success": true,
      "data": {
        "downloadUrl": "/downloads/placement-summary-2026-01.pdf",
        "fileName": "placement-summary-2026-01.pdf",
        "fileSize": "25.67KB",
        "expiresAt": "2026-01-12T13:42:00.000Z"
      }
    },
    "Export CSV Format": {
      "Tickets": "Subject, Status, Priority, Created By, Assigned To, Created At, Resolved At",
      "Team": "Name, Email, Role, Total Assigned, Resolved"
    },
    "Export PDF Format": {
      "Summary": "Formatted report with sections: Summary Stats, By Priority, By Status, Team Performance",
      "Includes": "Charts, tables, and formatted text"
    },
    "Export Note": "✨ CRITICAL FIX: Now generates ACTUAL CSV/PDF files instead of mock URLs!",
    "Export File Storage": {
      "Location": "/exports directory",
      "Retention": "24 hours (auto-deleted)",
      "Cleanup": "Automatic cleanup job runs periodically"
    },
    "Export Restrictions": {
      "CSV": "Supports tickets and team types only",
      "PDF": "Supports all types (tickets, team, summary)",
      "Permission": "Department head only",
      "Scope": "Department-scoped data only"
    }
  },
  "TESTING_GUIDE": {
    "Test Pagination": {
      "Endpoint": "GET /tickets?page=1&limit=20",
      "Steps": [
        "1. Create 25+ tickets",
        "2. List with limit=10",
        "3. Verify pagination metadata",
        "4. Navigate to page 2",
        "5. Verify different tickets shown"
      ],
      "Expected": "Pagination object with total, page, limit, pages"
    },
    "Test Transactions": {
      "Endpoint": "POST /department/tickets/bulk-assign",
      "Steps": [
        "1. Get 3 valid ticket IDs",
        "2. Bulk assign to staff member",
        "3. Verify all 3 assigned",
        "4. Try with invalid user ID",
        "5. Verify NO tickets assigned (rollback)"
      ],
      "Expected": "All-or-nothing behavior, no partial updates"
    },
    "Test Close Ticket": {
      "Endpoint": "PATCH /department/tickets/:id/close",
      "Steps": [
        "1. Create and resolve a ticket",
        "2. Close it as department head",
        "3. Verify status is CLOSED",
        "4. Try closing OPEN ticket (should fail)"
      ],
      "Expected": "Only RESOLVED tickets can be closed"
    },
    "Test File Download": {
      "Endpoint": "GET /tickets/:id/attachments/:attachmentId",
      "Steps": [
        "1. Upload file to ticket",
        "2. Get attachment ID from response",
        "3. Download using attachment ID",
        "4. Verify file downloads correctly",
        "5. Check filename and content"
      ],
      "Expected": "File downloads with correct name and content"
    },
    "Test Real Export": {
      "Endpoint": "GET /department/reports/export?format=csv&type=tickets",
      "Steps": [
        "1. Login as department head",
        "2. Request CSV export",
        "3. Check /exports directory",
        "4. Verify actual CSV file created",
        "5. Open file and check data"
      ],
      "Expected": "Real CSV/PDF file generated, not mock URL"
    }
  },
  "SUMMARY_OF_CHANGES": {
    "Total APIs": "57+",
    "New Endpoints": 2,
    "Enhanced Endpoints": 5,
    "Files Modified": 6,
    "New Endpoints List": [
      "PATCH /department/tickets/:id/close",
      "GET /tickets/:id/attachments/:attachmentId"
    ],
    "Enhanced Endpoints List": [
      "GET /tickets (now paginated)",
      "POST /department/tickets/bulk-assign (now transactional)",
      "POST /department/tickets/bulk-status (now transactional)",
      "POST /tickets/:id/attachments (file upload)",
      "GET /department/reports/export (real files)"
    ],
    "Critical Fixes Applied": 4,
    "Production Ready": "YES"
  },
  "ROLE_BASED_API_SUMMARY": {
    "STUDENT_ROLE": {
      "Total APIs": 14,
      "New Features": [
        "Pagination on ticket listing",
        "File upload to tickets",
        "File download from tickets",
        "Ticket rating system"
      ],
      "Key Endpoints": [
        "GET /tickets?page=1&limit=20 (paginated)",
        "POST /tickets/:id/attachments (upload)",
        "GET /tickets/:id/attachments/:id (download)",
        "POST /tickets/:id/rate (rate ticket)"
      ]
    },
    "DEPARTMENT_STAFF_ROLE": {
      "Total APIs": 7,
      "Features": [
        "View assigned tickets",
        "Update ticket status",
        "Add comments",
        "View unassigned tickets",
        "Personal dashboard",
        "Performance metrics"
      ],
      "Key Endpoints": [
        "GET /department/staff/my-tickets",
        "PATCH /department/staff/my-tickets/:id/status",
        "POST /department/staff/my-tickets/:id/comments"
      ]
    },
    "DEPARTMENT_HEAD_ROLE": {
      "Total APIs": 16,
      "New Features": [
        "Close resolved tickets",
        "Transactional bulk assign",
        "Transactional bulk status update",
        "Real CSV/PDF export"
      ],
      "Key Endpoints": [
        "PATCH /department/tickets/:id/close (new)",
        "POST /department/tickets/bulk-assign (transactional)",
        "POST /department/tickets/bulk-status (transactional)",
        "GET /department/reports/export (real files)"
      ]
    }
  }
}